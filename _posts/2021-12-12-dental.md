---
layout: post
title: Detection and Classification of Dental Panoramics with Mask R-CNNs
subtitle: Automating the Analysis of Dental X-Rays.
author: Mehdi Amine
---

## Introduction

Please note that this post is still under construction, but I'm choosing to publish it while incrementally adding to it.

At the time in which this post is being written, I still consider this project my greatest work. I describe here its objectives, techniques, limitations and achievements. 

Besides the technicalities that led to the results, it also matters for me to present the personal circumstances and the challenges that surrounded the work. I believe this approach enriches the text and promotes the engagement of my reader. It is also more enjoyable for me as the writer. I hope my enjoyment writing becomes your enjoyment reading. 


## Objectives

Dentists keep records of the state and progress of each patient. One process through which these records are structured is the creation of dental charts. These charts are graphical representations of the 32 types of human permanent teeth labelled according to a specific nomenclature. In dental charts each tooth can be assigned with a set of attributes that are either pathologies or restorations. The nomenclature used for labelling teeth in this project is FDI.

Dental charts used to be done on paper. Nowadays several software options are available for dentists. Some of them include speech control to enable vocal dictation. Despite its advances, the process remains slow and very redundant, and several dentists have started to look for solutions to accelerate it.

Research targetting the application of computer vision on this problem has achieved considerable results. Different methods have been applied with great success and led to the release of powerful software to assist dentists. My employer was interested in the implementation of a competing solution. Having previously developed a software that enabled the creation of dental charts through typing or voice control, they felt they could do better. They recruited me for this purpose.

At the time of my recruitment I had nearly exhausted my hopes of ever finding employment. I had graduated from my master's with very poor grades, couldn't find visa sponsoring work abroad, and couldn't find open positions in my country. Because of this, I suffered from low self-esteem and frail mental health.

Perhaps from fear of disappointing more than from sincerety, I tested my own competences before proceding with the job interview. In other words, I evaluated myself to see if it was worth letting others evaluate me. My anxiety wouldn't settle otherwise.

I was successful in implementing a Resnet to classify dental images based on the presence of tooth decay. I presented this work to my employer and gained their approval. Previous lurkings on Kaggle made me aware of the availability of [the dataset](https://www.kaggle.com/pushkar34/teeth-dataset) towards which I owe my success in being able to secure my first job.

Despite this small success, my low self-esteem was still in charge. I kept asking my employer during the interview whether I will be assisted in this position. Whether dentists will provide the required data. These questions were answered with affirmation. Not long after, I realized I was the only person recruited to do the whole work. The whole work, including the annotation of data.

The objectives in their order of execution were:
1. Detecting and classifying the 32 types of permanent teeth.
2. Detecting and classifying attributes that a tooth can have:
    - Implants.
    - Crowns attached to implants. 
    - Bridges and their components (pillars and pontics).
    - Missing teeth, including cases in which orthodontic treatments extracted a tooth and closed the gap between its two adjacent teeth.
    - Endodontic treatments. Otherwise known as root canals.
    - Caries.
3. Processing the outputs of the first and second objectives in a cohesive description that associated attributes to their assigned tooth.

Unlike this list, the reality was unstructured. Initially the objectives were described in very broad terms, we did not know what would be feasible. They continued to grow in ambition and complexity relative to the results I was delivering. 

## Data Annotation

### On Becoming a Dentist

I was provided with a dataset of around 16000 dental X-rays. The dataset was limited to images of panoramic radiographs and did not contain any ground truth. My accelerated course on the field of dentistry was done during a 30 minute call with my employer's partner. By the end of the conversation, I was deemed ready for my first task: detecting and classifying teeth according to the FDI notation.

|![fdi](assets/dental_imgs/fdi.png)|
|:--:|
| [*FDI teeth numbering system.*](https://www.researchgate.net/figure/FDI-teeth-numbering-system-11-18right-upper-1-8-21-28left-upper-1-8-31-38left-lower_fig4_331569041) Chen, Hu & Zhang, Kailai & Lyu, Peijun & Li, Hong & Zhang, Ludan & Wu, Ji & Lee, Chin-Hui. (2019)|

I was under lots of pressure. Every tooth is unique. Human teeth differ in size and shape from one person to another. I could not define a single rule for which I did not find a plethora of exceptions. 

Not all canines are elongated and pointy. Molars are not always bigger than premolars. The four mandibular incisors all look the same more often than not... The position of a tooth is a nice indicator, but relative to what? Another tooth? That would not only shift the same problem to another tooth, but it would also fail to account for cases of missing teeth.

Part of my confusion was caused by a frame of mind that was trying to solve the problem. This is a problem for which solutions can only be approximated. With extensive research, a couple all-nighters, and barrels of coffee and tea, I tuned my human model to analyze dental x-rays. Part of the tuning was letting go of perfection. Expert dentists make frequent errors classifying a tooth from an image cropped out of its context. Teeth do not carry (pun totally unintended) inherent visual properties that are reliable enough to distinguish them with high precision. This is especially the case between teeth of the same families: the 12 molars, 8 premolars, 4 canines, 8 incisors. And between families that are adjacent to one another: molars with premolars, premolars with canines, and canines with incisors.

In other words:
- Telling apart molars from canines, or premolars from incisors, is evident. 
- Telling apart molars from premolars, or canines from incisors, is much less evident. 
- Telling apart one molar from another, or one incisor from another, is in many cases impossible without relying on information other than shape and size.


The sensible approach would have been to confront my employer. I was told prior to my recruitment that I will be assisted and that the relevant data will be provided by dentists. But even under normal circumstances, I am too agreeable for my own good. 

### Hasty
Every published research I could find was relying on bounding boxes for teeth annotations. They made sense in terms of ease of use; dragging a rectangular frame around a tooth is quicker than drawing polygonal contours. Besides, image annotation tools, especially the free ones, are predominantly limited to bounding boxes. This goes in line with the fact that prior to the advance of segmentation models, object detection models did not require more than rectangular frames for the label input.

I was not convinced that this was a better approach compared to polygonal contours. The crowded space in dental x-rays conflicted with the straight rectangular nature of bounding boxes. Teeth are seldom straight from root to crown. Hence most bounding boxes end up including not only the target tooth, but also parts of its neighboors on both sides.

I could not hope to compete with large teams of dentists collaborating to annotate an abundant number of instances. I could however hope that a more precise annotation would compensate for the number difference. Quality over quantity.

## Results
In this section, I run inference with different panoramics to demonstrate the capabilities of the system. Let's begin with a simple panoramic: no missing teeth other than the four commonly missing wisdom teeth, all remaining teeth are intact. 

You can use the FDI chart for reference to evaluate the output. The number on the left of each bounding box is the inferred FDI label, the percentage is the probability associated with each output: or the certainty level of the model.

|![pano1](assets/dental_imgs/p1.jpg)|
|:--:|
|*X-ray Image Input.*|
|:--:|
|![result1](assets/dental_imgs/r1.jpg)|
|:--:|
|*X-ray Image with visualization of the model output.*|

<p align="center"><iframe width="560" height="315" src="https://www.youtube.com/embed/OhbmKx8DehI" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></p>

